(()=>{var e={};e.id=4575,e.ids=[4575],e.modules={2006:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=2006,e.exports=t},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{"use strict";e.exports=require("http")},95687:e=>{"use strict";e.exports=require("https")},85477:e=>{"use strict";e.exports=require("punycode")},12781:e=>{"use strict";e.exports=require("stream")},57310:e=>{"use strict";e.exports=require("url")},59796:e=>{"use strict";e.exports=require("zlib")},97731:(e,t,r)=>{"use strict";r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>g,requestAsyncStorage:()=>m,routeModule:()=>l,serverHooks:()=>y,staticGenerationAsyncStorage:()=>_});var s={};r.r(s),r.d(s,{POST:()=>p,runtime:()=>u});var i=r(49303),n=r(88716),a=r(60670),o=r(69498),d=r(9185),c=r.n(d);let u="nodejs";async function p(e){try{let t=process.env.SUPABASE_URL||"https://ueunqeqrvtuofpdoozye.supabase.co",r=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVldW5xZXFydnR1b2ZwZG9venllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxOTM4NjMsImV4cCI6MjA3MTc2OTg2M30.JY5i-uB5vZJ6enhWVgf9Bwg9bK2BFjmuXuOfjbQEQUw";if(!t||!r)return new Response("Server misconfigured: missing SUPABASE_URL/SUPABASE_SERVICE_ROLE_KEY",{status:500});let s=process.env.REPLICATE_API_TOKEN||"";if(!s)return new Response("Server misconfigured: missing REPLICATE_API_TOKEN",{status:500});let i=await e.json(),n=(0,o.eI)(t,r,{auth:{persistSession:!1}}),a=[];if(i?.segments&&Array.isArray(i.segments))a=i.segments.map((e,t)=>({id:e.id||`seg_${t}`,text:e.text,intent:e.intent||"",keywords:Array.isArray(e.keywords)?e.keywords:[],visual_style:e.visual_style||""}));else{if(!i?.script_id)return new Response("Provide segments or script_id",{status:400});let{data:e}=await n.from("script_segments").select("id, text, intent, keywords, visual_style").eq("script_id",i.script_id).order("id",{ascending:!0});a=(e||[]).map(e=>({id:String(e.id),text:e.text||"",intent:e.intent||"",keywords:e.keywords||[],visual_style:e.visual_style||""}))}let d=new(c())({auth:s}),u=process.env.REPLICATE_EMBED_MODEL||"lucataco/snowflake-arctic-embed-l:38f2c666dd6a9f96c50eca69bbb0029ed03cba002a289983dc0b487a93cfb1b4",p=process.env.REPLICATE_SEQUENCE_MODEL||"meta/meta-llama-3-70b-instruct",l={};for(let e of a){let t=[e.text,e.intent,e.keywords?.join(" "),e.visual_style].filter(Boolean).join("\n"),r=await d.run(u,{input:{prompt:t}}),s=Array.isArray(r)?r.map(e=>Number(e)):Array.isArray(r?.data)?r.data.map(e=>Number(e)):[],i=null;try{let{data:e}=await n.rpc("match_assets",{query_embedding:s,match_count:12});i=e||null}catch{}if(!i){let{data:e}=await n.from("media_assets").select("id, type"),t=e||[],{data:r}=await n.from("media_index").select("asset_id, embedding"),a=new Map;(r||[]).forEach(e=>a.set(String(e.asset_id),e.embedding||[])),i=t.map(e=>{let t=a.get(String(e.id))||[],r=t.length===s.length?t.reduce((e,t,r)=>e+t*s[r],0):0,i=Math.sqrt(t.reduce((e,t)=>e+t*t,0)),n=Math.sqrt(s.reduce((e,t)=>e+t*t,0)),o=i>0&&n>0?r/(i*n):0;return{id:e.id,score:o}}).sort((e,t)=>t.score-e.score).slice(0,12)}l[e.id]=i}let m=a.map(e=>({segment_id:e.id,text:e.text,intent:e.intent,keywords:e.keywords,visual_style:e.visual_style,candidates:(l[e.id]||[]).map(e=>({id:e.id,score:e.score}))})),_=`You are an expert UGC editor. For each segment, pick one candidate asset id and provide a one-sentence rationale and a confidence 0..1. Return JSON { items: [{ segment_id, chosen_asset_id, rationale, confidence }] } only.

DATA:
${JSON.stringify(m)}`,y=await d.run(p,{input:{prompt:_,temperature:.1}}),f="string"==typeof y?y:Array.isArray(y)?y.join("\n"):JSON.stringify(y),g=f.indexOf("{"),E=f.lastIndexOf("}"),A=g>=0&&E>=0?(()=>{try{return JSON.parse(f.slice(g,E+1))}catch{return{items:[]}}})():{items:[]},w=Array.isArray(A.items)?A.items:[];if(i?.dry_run)return Response.json({ok:!0,items:w,candidates:l});if(i?.script_id)for(let e of w)try{await n.from("sequence_map").insert({script_segment_id:e.segment_id,asset_id:e.chosen_asset_id,rationale:e.rationale||"",confidence:"number"==typeof e.confidence?e.confidence:null})}catch{}return Response.json({ok:!0,items:w,candidates:l})}catch(t){let e=t instanceof Error?t.message:"Internal error";return new Response(`Error: ${e}`,{status:500})}}let l=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/sequence/route",pathname:"/api/sequence",filename:"route",bundlePath:"app/api/sequence/route"},resolvedPagePath:"/Users/Aaron/Downloads/next-lipsync-app/app/api/sequence/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:_,serverHooks:y}=l,f="/api/sequence/route";function g(){return(0,a.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:_})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,2659,9185,9498],()=>r(97731));module.exports=s})();