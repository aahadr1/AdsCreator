"use strict";(()=>{var e={};e.id=894,e.ids=[894],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32081:e=>{e.exports=require("child_process")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},71017:e=>{e.exports=require("path")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},8445:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>A,patchFetch:()=>P,requestAsyncStorage:()=>w,routeModule:()=>f,serverHooks:()=>_,staticGenerationAsyncStorage:()=>U});var o={};t.r(o),t.d(o,{POST:()=>S,runtime:()=>g});var s=t(49303),n=t(88716),a=t(60670),i=t(32081),u=t(69498),p=t(71017),l=t.n(p);let d=require("os");var c=t.n(d);let m=require("fs/promises");var v=t.n(m);let g="nodejs";async function S(e){try{let r=await e.json().catch(()=>null);if(!r||!r.video_url)return new Response("Missing video_url",{status:400});let t=process.env.SUPABASE_URL,o=process.env.SUPABASE_SERVICE_ROLE_KEY;process.env.SUPABASE_BUCKET;let s=process.env.SUPABASE_OUTPUTS_BUCKET||"outputs";if(!t||!o)return new Response("Server misconfigured: missing SUPABASE_URL/SUPABASE_SERVICE_ROLE_KEY",{status:500});let n=(0,u.eI)(t,o,{auth:{persistSession:!1}}),a=await v().mkdtemp(`${c().tmpdir()}${l().sep}bgremove-`),p=l().join(a,"input.mp4"),d=(r.output_basename||"output").replace(/[^a-zA-Z0-9_.-]/g,"_"),m=l().join(a,`${d}.mov`),g=await fetch(r.video_url);if(!g.ok||!g.body)return new Response("Failed to download input",{status:400});let S=await g.arrayBuffer();await v().writeFile(p,Buffer.from(S));let f=process.env.PYTHON_PATH||"python3",w=(0,i.spawn)(f,["-m","backgroundremover.cmd.cli","-i",p,"-tv","-o",m],{stdio:["ignore","pipe","pipe"]}),U=[];w.stdout.on("data",e=>U.push(String(e))),w.stderr.on("data",e=>U.push(String(e)));let _=await new Promise(e=>w.on("close",e));if(0!==_)return new Response(`Background removal failed (exit ${_})
${U.join("")}`,{status:500});let A=await v().readFile(m),P=`bgremove/${Date.now()}-${d}.mov`,{error:h}=await n.storage.from(s).upload(P,A,{contentType:"video/quicktime",upsert:!1,cacheControl:"3600"});if(h)return new Response(`Upload failed: ${h.message}`,{status:500});if("true"===(process.env.SUPABASE_OUTPUTS_BUCKET_PUBLIC||"true").toLowerCase()){let{data:e}=n.storage.from(s).getPublicUrl(P);return Response.json({url:e.publicUrl})}{let{data:e,error:r}=await n.storage.from(s).createSignedUrl(P,3600);if(r)return new Response(`Signed URL failed: ${r.message}`,{status:500});return Response.json({url:e.signedUrl})}}catch(e){return new Response(`Error: ${e.message}`,{status:500})}}let f=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/background/remove/route",pathname:"/api/background/remove",filename:"route",bundlePath:"app/api/background/remove/route"},resolvedPagePath:"/Users/Aaron/Downloads/next-lipsync-app/app/api/background/remove/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:w,staticGenerationAsyncStorage:U,serverHooks:_}=f,A="/api/background/remove/route";function P(){return(0,a.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:U})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[8948,2659,9498],()=>t(8445));module.exports=o})();