(()=>{var e={};e.id=1666,e.ids=[1666],e.modules={2006:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=2006,e.exports=t},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{"use strict";e.exports=require("http")},95687:e=>{"use strict";e.exports=require("https")},85477:e=>{"use strict";e.exports=require("punycode")},12781:e=>{"use strict";e.exports=require("stream")},57310:e=>{"use strict";e.exports=require("url")},59796:e=>{"use strict";e.exports=require("zlib")},41608:(e,t,s)=>{"use strict";s.r(t),s.d(t,{originalPathname:()=>h,patchFetch:()=>A,requestAsyncStorage:()=>y,routeModule:()=>_,serverHooks:()=>f,staticGenerationAsyncStorage:()=>g});var r={};s.r(r),s.d(r,{POST:()=>m,runtime:()=>l});var a=s(49303),i=s(88716),n=s(60670),o=s(69498),c=s(9185),p=s.n(c);let l="nodejs";async function u({supabaseUrl:e,serviceRoleKey:t,bucket:s,publicBucket:r}){let a=(0,o.eI)(e,t,{auth:{persistSession:!1}});try{let{data:e}=await a.storage.getBucket(s);e||await a.storage.createBucket(s,{public:r})}catch{}}async function d({assetUrl:e,kind:t,replicate:s}){try{let r;let a="Return strictly valid JSON with keys: { title, summary, scene_category, subjects, actions, product_present, product_names, brand_logos, has_text, text_in_scene, emotion_tone, shot_types, camera_movements, duration_seconds, key_moments }. Types: title:string; summary:string; scene_category:string; subjects:string[]; actions:string[]; product_present:boolean; product_names:string[]; brand_logos:string[]; has_text:boolean; text_in_scene:string; emotion_tone:string[]; shot_types:string[]; camera_movements:string[]; duration_seconds:number|null; key_moments:Array<{timestamp:string,label:string}>.";if("video"===t){let t=`${a} Focus on what is visually happening and what would help an auto-editor pick B-roll.`;r=await s.run("lucataco/apollo-7b",{input:{video:e,prompt:t,temperature:.2,max_new_tokens:512,top_p:.7}})}else{let t=`${a} The media is an image. Analyze the image and output the JSON only.`;r=await s.run("openai/gpt-4.1-mini",{input:{prompt:t,image_input:[e],temperature:.2,max_completion_tokens:512,system_prompt:"You are a precise visual analyst. Respond with JSON only."}})}let i="string"==typeof r?r:Array.isArray(r)?r.map(e=>String(e)).join("\n"):JSON.stringify(r),n=i.indexOf("{"),o=i.lastIndexOf("}"),c=n>=0&&o>=0?i.slice(n,o+1):i,p={};try{p=JSON.parse(c)}catch{}let l="string"==typeof p.title&&p.title.trim()?p.title.trim():"Untitled asset",u="string"==typeof p.summary?p.summary.trim():"",d=Array.isArray(p.subjects)?p.subjects.filter(e=>"string"==typeof e):[],m=Array.isArray(p.actions)?p.actions.filter(e=>"string"==typeof e):[],_=Array.isArray(p.product_names)?p.product_names.filter(e=>"string"==typeof e):[],y=Array.isArray(p.brand_logos)?p.brand_logos.filter(e=>"string"==typeof e):[],g=Array.isArray(p.emotion_tone)?p.emotion_tone.filter(e=>"string"==typeof e):[],f="string"==typeof p.scene_category?p.scene_category:"",h=[...d,...m,..._,...y,f,...g].filter(e=>"string"==typeof e&&e.trim()).slice(0,24),A=[l,u].filter(Boolean).join(" — "),b=[l,u,h.join(" ")].filter(Boolean).join("\n"),w=[];try{let e=process.env.REPLICATE_EMBED_MODEL||"lucataco/snowflake-arctic-embed-l:38f2c666dd6a9f96c50eca69bbb0029ed03cba002a289983dc0b487a93cfb1b4",t=await s.run(e,{input:{prompt:b}});w=Array.isArray(t)?t:t?.data||t?.embedding||[]}catch{w=[]}let v={title:l,summary:u,scene_category:f,subjects:d,actions:m,product_present:!!p.product_present,product_names:_,brand_logos:y,has_text:!!p.has_text,text_in_scene:"string"==typeof p.text_in_scene?p.text_in_scene:"",emotion_tone:g,shot_types:Array.isArray(p.shot_types)?p.shot_types:[],camera_movements:Array.isArray(p.camera_movements)?p.camera_movements:[],duration_seconds:"number"==typeof p.duration_seconds?p.duration_seconds:null,key_moments:Array.isArray(p.key_moments)?p.key_moments:[],source_model:"video"===t?"lucataco/apollo-7b":"openai/gpt-4.1-mini"};return{title:l,description:A,labels:h,keywords:h,embedding:Array.isArray(w)?w.map(e=>Number(e)):[],analysis:v}}catch{return null}}async function m(e){try{let t=process.env.SUPABASE_URL||"https://ueunqeqrvtuofpdoozye.supabase.co",s=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVldW5xZXFydnR1b2ZwZG9venllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxOTM4NjMsImV4cCI6MjA3MTc2OTg2M30.JY5i-uB5vZJ6enhWVgf9Bwg9bK2BFjmuXuOfjbQEQUw",r=process.env.SUPABASE_ASSETS_BUCKET||"assets",a="true"===(process.env.SUPABASE_BUCKET_PUBLIC||"true").toLowerCase();if(!t||!s)return new Response("Server misconfigured: missing SUPABASE_URL/SUPABASE_SERVICE_ROLE_KEY",{status:500});let{url:i,kind:n,user_id:c}=await e.json()||{};if(!i||"string"!=typeof i)return new Response("Missing url",{status:400});let l="image"===n||"video"===n?n:/\.(png|jpg|jpeg|gif|webp)(\?|$)/i.test(i)?"image":"video",m=null;if("string"==typeof c&&c&&(m=c),!m){let r=e.headers.get("authorization")||"",a=r.toLowerCase().startsWith("bearer ")?r.slice(7):"";if(a)try{let e=(0,o.eI)(t,s,{auth:{persistSession:!1},global:{headers:{Authorization:`Bearer ${a}`}}}),{data:{user:r}}=await e.auth.getUser();r?.id&&(m=r.id)}catch{}}await u({supabaseUrl:t,serviceRoleKey:s,bucket:r,publicBucket:a});let _=(0,o.eI)(t,s,{auth:{persistSession:!1}}),y=await fetch(i);if(!y.ok)return new Response(`Failed to fetch media: ${y.statusText}`,{status:400});let g=await y.arrayBuffer(),f=y.headers.get("content-type")||("image"===l?"image/png":"video/mp4"),h=f.includes("png")?"png":f.includes("jpeg")||f.includes("jpg")?"jpg":f.includes("webp")?"webp":f.includes("gif")?"gif":f.includes("mp4")?"mp4":f.includes("quicktime")?"mov":"bin",A=i.split("/").pop()?.split("?")[0]?.replace(/[^a-zA-Z0-9_.-]/g,"_")||`asset.${h}`,b=`assets/${Date.now()}-${A}`,{error:w}=await _.storage.from(r).upload(b,new Uint8Array(g),{upsert:!1,cacheControl:"3600",contentType:f});if(w)return new Response(`Upload failed: ${w.message}`,{status:500});let v=a?_.storage.from(r).getPublicUrl(b).data.publicUrl:(await _.storage.from(r).createSignedUrl(b,60*60)).data?.signedUrl||"";try{await _.from("media_assets").update({public_url:v,mime_type:f,bucket:r}).eq("storage_path",b)}catch{}let x=null;try{let{data:e,error:t}=await _.from("media_assets").insert({created_by:m,type:l,storage_path:b,status:"pending"}).select("*").single();t||(x=e)}catch{}let S=null;try{let e=process.env.REPLICATE_API_TOKEN;if(e){let t=new(p())({auth:e}),s=await d({assetUrl:v||i,kind:l,replicate:t});if(s){let{title:e,description:t,labels:r,keywords:a,embedding:i,analysis:n}=s;try{if(Array.isArray(r)&&r.length){let e=r.map(e=>({asset_id:x?.id,label:e,confidence:null,source:"replicate"}));await _.from("media_labels").insert(e)}}catch{}try{(t||e)&&await _.from("media_descriptions").insert({asset_id:x?.id,description:[e,t].filter(Boolean).join(" — "),source:"replicate"})}catch{}try{Array.isArray(i)&&i.length&&await _.from("media_index").insert({asset_id:x?.id,embedding:i,index_version:1})}catch{}try{n&&x?.id&&await _.from("media_analysis").insert({asset_id:x.id,analysis:n})}catch{}try{let{data:e}=await _.from("media_assets").update({status:"ready"}).eq("storage_path",b).select("*").single();S=e||null}catch{}}}}catch{}return Response.json({ok:!0,bucket:r,path:b,publicUrl:v,userId:m,asset:S||x||null})}catch(e){return new Response(`Error: ${e.message}`,{status:500})}}let _=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/assets/add/route",pathname:"/api/assets/add",filename:"route",bundlePath:"app/api/assets/add/route"},resolvedPagePath:"/Users/Aaron/Downloads/next-lipsync-app/app/api/assets/add/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:y,staticGenerationAsyncStorage:g,serverHooks:f}=_,h="/api/assets/add/route";function A(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:g})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[8948,2659,9185,9498],()=>s(41608));module.exports=r})();